<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jeu du Mariage</title>
  <link rel="stylesheet" href="styles.css" /> <!-- Ajoute ton CSS ici -->
</head>
<body>
  <div id="jeu">
    <h1>Jeu du Mariage</h1>
    
    <!-- Liste des 13 objets à trouver (indices pour le joueur) -->
    <h2>Objets à trouver :</h2>
    <ul id="objets-a-trouver">
      <li>chaussure femme</li>
      <li>Bretelles</li>
      <li>Carte d'identité</li>
      <li>Ceinture</li>
      <li>Clef</li>
      <li>Marié H</li>
      <li>Brosse</li>
      <li>Mariée F</li>
      <li>Mouchoir orange</li>
      <li>Nœud papillon</li>
      <li>Portefeuille</li>
      <li>Rouge à lèvre</li>
      <li>Tasse</li>
    </ul>
    
    <!-- Conteneur pour l'image (pour centrage et responsive) -->
    <div id="image-container">
      <img src="scene.png" alt="Scène de mariage" usemap="#scene-map" id="scene-image">
      <p id="image-error" style="display: none; color: red;">Erreur : Impossible de charger l'image scene.png. Vérifiez le fichier !</p>
    </div>
    
    <!-- Map des zones cliquables (générée dynamiquement en JS) -->
    <map name="scene-map" id="scene-map"></map>
    
    <button id="nouvelle-partie">Nouvelle Partie</button>
    <p id="temps">Temps : 0s</p>
    
    <!-- Modal pour le pseudo (seulement pseudo, temps auto-calculé avec pénalités) -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <h2>Félicitations !</h2>
        <p>Vous avez gagné en <span id="temps-final"></span> secondes !</p>
        <input type="text" id="pseudo" placeholder="Entrez votre pseudo" />
        <button id="enregistrer">Enregistrer mon score</button>
      </div>
    </div>
    
    <div id="classement">
      <h2>Classement des meilleurs scores</h2>
      <!-- Le leaderboard sera affiché ici -->
    </div>
  </div>

  <!-- Scripts Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js"></script>

  <script>
    // Configuration Firebase (tes valeurs exactes)
    const firebaseConfig = {
      apiKey: "AIzaSyAAIr_vGlCMM9iuRwnqOQhb2cwv7DIVJFk",
      authDomain: "classementjeu-a2f8a.firebaseapp.com",
      projectId: "classementjeu-a2f8a",
      storageBucket: "classementjeu-a2f8a.firebasestorage.app",
      messagingSenderId: "70538879353",
      appId: "1:70538879353:web:05b35cb2c3930c34380fa8",
      measurementId: "G-JXNCRWDN5C"
    };

    // Initialisation de Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Variables pour le timer automatique et la logique du jeu
    let debutTimer;
    let intervalTimer;
    let objetsTrouves = 0;  // Compteur d'objets bons trouvés
    const totalObjets = 13;  // 13 objets à trouver
    let penalites = 0;  // Compteur de pénalités (+1 par intrus cliqué)

    // Liste des zones cliquables (exactement tes données)
    const zones = [
      { nom: "Clef", x: 3.2, y: 3.2, w: 19, h: 14.8, intrus: false },
      { nom: "Télécommande", x: 20.6, y: 2.2, w: 38.1, h: 14.8, intrus: true },
      { nom: "Couteau", x: 38.4, y: 3.2, w: 55.3, h: 13.7, intrus: true },
      { nom: "Portefeuille", x: 55.5, y: 3.2, w: 77.5, h: 13.7, intrus: false },
      { nom: "Ceinture", x: 4.8, y: 27.4, w: 23.7, h: 33.7, intrus: false },
      { nom: "Bouteille d'eau", x: 26.9, y: 30.5, w: 36.4, h: 46.3, intrus: true },
      { nom: "Corde bizarre", x: 23.7, y: 19, w: 45.9, h: 28.4, intrus: true },
      { nom: "Marié H", x: 47.4, y: 14.8, w: 59.1, h: 48.4, intrus: false },
      { nom: "Mariée F", x: 59.3, y: 15.8, w: 75.9, h: 48.4, intrus: false },
      { nom: "Lunettes", x: 75.9, y: 13.7, w: 96.4, h: 19, intrus: true },
      { nom: "Masque 1", x: 75.9, y: 20, w: 96.4, h: 13.7, intrus: true },
      { nom: "Savon", x: 77.5, y: 27.4, w: 86.1, h: 40, intrus: true },
      { nom: "L Coton", x: 86.9, y: 28.4, w: 96.4, h: 35.8, intrus: true },
      { nom: "Brosse", x: 87.1, y: 36.9, w: 95.6, h: 52.6, intrus: false },
      { nom: "Tasse", x: 6.4, y: 47.4, w: 19, h: 54.7, intrus: false },
      { nom: "Pièce", x: 23.7, y: 47.4, w: 31.6, h: 51.6, intrus: true },
      { nom: "Stylo", x: 31.8, y: 46.3, w: 44, h: 53.7, intrus: true },
      { nom: "Bague moche", x: 44.1, y: 49.5, w: 52.2, h: 53.2, intrus: true },
      { nom: "Mouchoir bleu", x: 3.8, y: 58.1, w: 11.6, h: 61.8, intrus: true },
      { nom: "Chaussure homme", x: 12.5, y: 56.8, w: 30.1, h: 66.3, intrus: true },
      { nom: "Cravate verte", x: 33.2, y: 54.4, w: 41.1, h: 70.5, intrus: true },
      { nom: "Rouge à lèvre", x: 43.7, y: 55.8, w: 48.2, h: 66.3, intrus: false },
      { nom: "Montre", x: 52.3, y: 50.5, w: 63.2, h: 63.7, intrus: true },
      { nom: "Crayon piège", x: 67.5, y: 53.7, w: 84.3, h: 58.8, intrus: true },
      { nom: "Masque 2", x: 5.4, y: 68.4, w: 23.9, h: 76.9, intrus: true },
      { nom: "Bretelles", x: 42.4, y: 66.4, w: 59.1, h: 76.9, intrus: false },
      { nom: "Nain", x: 63.4, y: 58.9, w: 74.3, h: 74.4, intrus: true },
      { nom: "Lampe de poche bleue", x: 75.6, y: 61.1, w: 86.8, h: 70.5, intrus: true },
      { nom: "Clé USB", x: 88.5, y: 62, w: 95.2, h: 69.3, intrus: true },
      { nom: "Sandale", x: 4.8, y: 84.2, w: 25.3, h: 95.7, intrus: true },
      { nom: "Briquet", x: 28.3, y: 85, w: 33.5, h: 94.8, intrus: true },
      { nom: "Boite bague", x: 36.9, y: 87, w: 46.5, h: 92.5, intrus: true },
      { nom: "Billet ", x: 42.5, y: 78.7, w: 58.5, h: 86.4, intrus: true },
      { nom: "Nœud papillon", x: 59.8, y: 75.5, w: 73.4, h: 80.8, intrus: false },
      { nom: "Carte d'identité", x: 77, y: 71.4, w: 87.6, h: 77.9, intrus: false },
      { nom: "Allumette", x: 87.7, y: 75.5, w: 94.8, h: 81.3, intrus: true },
      { nom: "Mouchoir orange", x: 61.8, y: 82.2, w: 72.4, h: 87.5, intrus: false },
      { nom: "Ange", x: 73.8, y: 84.1, w: 82.2, h: 94.8, intrus: true },
      { nom: "chaussure femme", x: 46.7, y: 88.4, w: 55, h: 92, intrus: false }
    ];

    // Fonction pour générer dynamiquement les zones cliquables (basé sur % de l'image)
    function genererZones() {
      const img = document.getElementById('scene-image');
      const map = document.getElementById('scene-map');
      map.innerHTML = '';  // Reset la map
      console.log('Génération des zones... Image size:', img.width, 'x', img.height);

      zones.forEach((zone, index) => {
        const x1 = Math.round((zone.x / 100) * img.width);
        const y1 = Math.round((zone.y / 100) * img.height);
        const x2 = Math.round((zone.w / 100) * img.width) + x1;  // w et h sont des largeurs/hauteurs en %
        const y2 = Math.round((zone.h / 100) * img.height) + y1;

        const area = document.createElement('area');
        area.shape = 'rect';
        area.coords = `${x1},${y1},${x2},${y2}`;
        area.alt = zone.nom;
        area.dataset.id = index;  // ID unique pour la zone
        area.onclick = () => trouverObjet(index);  // Associe le clic
        map.appendChild(area);
      });
      console.log('Zones générées avec succès !');
    }

    // Fonction pour démarrer le timer
    function startTimer() {
      debutTimer = Date.now();
      document.getElementById("temps").textContent = "Temps : 0s";
      intervalTimer = setInterval(() => {
        const tempsEcoule = Math.floor((Date.now() - debutTimer) / 1000);
        document.getElementById("temps").textContent = `Temps : ${tempsEcoule}s`;
      }, 1000);
    }

    // Fonction pour arrêter le timer et calculer le temps final (nombre)
    function stopTimer() {
      clearInterval(intervalTimer);
      const tempsEcoule = Math.floor((Date.now() - debutTimer) / 1000);
      return tempsEcoule + penalites;  // Retourne un nombre (temps + pénalités)
    }

    // Fonction pour gérer un clic sur une zone
    function trouverObjet(id) {
      const zone = zones[id];
      const area = document.querySelector(`area[data-id="${id}"]`);
      if (!area || area.dataset.found) return;  // Déjà trouvée

      // Marque comme trouvée
      area.dataset.found = 'true';
      area.onclick = null;

      if (zone.intrus) {
        penalites += 1;
        console.log(`Intrus cliqué : ${zone.nom} - +1s pénalité ! Pénalités : ${penalites}`);
      } else {
        objetsTrouves++;
        console.log(`Bon objet trouvé : ${zone.nom} ! Objets : ${objetsTrouves}/${totalObjets}`);
      }

      if (objetsTrouves >= totalObjets) {
        const tempsFinal = stopTimer();
        document.getElementById("temps-final").textContent = tempsFinal;
        document.getElementById("modal").style.display = "block";
      }
    }

    // Fonction pour enregistrer un score dans Firestore (temps comme nombre pour tri)
    function enregistrerScore(pseudo, temps) {
      if (!pseudo) {
        alert("Veuillez entrer un pseudo !");
        return;
      }
      db.collection("scores").add({
        pseudo: pseudo,
        temps: parseInt(temps),  // Stocke comme nombre
        date: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert("Score enregistré avec succès !");
        document.getElementById("modal").style.display = "none";
        document.getElementById("pseudo").value = "";
      })
      .catch((error) => {
        console.error("Erreur d'enregistrement :", error);
        alert("Erreur lors de l'enregistrement du score.");
      });
    }

    // Fonction pour charger le classement en temps réel
    function chargerClassement() {
      const classementDiv = document.getElementById("classement");
      db.collection("scores")
        .orderBy("temps", "asc")  // Tri par temps croissant
        .limit(10)
        .onSnapshot((snapshot) => {
          classementDiv.innerHTML = "<h2>Classement des meilleurs scores</h2><ol>";
          if (snapshot.empty) {
            classementDiv.innerHTML += "<li>Aucun score pour le moment.</li>";
          } else {
            snapshot.forEach((doc) => {
              const data = doc.data();
              classementDiv.innerHTML += `<li>${data.pseudo} - ${data.temps}s (${new Date(data.date?.toDate()).toLocaleDateString()})</li>`;
            });
          }
          classementDiv.innerHTML += "</ol>";
        }, (error) => {
          console.error("Erreur de chargement :", error);
          classementDiv.innerHTML = "<p>Erreur lors du chargement du classement.</p>";
        });
    }

    // Logique de nouvelle partie
    document.getElementById("nouvelle-partie").addEventListener("click", function() {
      objetsTrouves = 0;
      penalites = 0;
      document.getElementById("modal").style.display = "none";
      // Reset toutes les areas (supprime 'found' et réassocie onclick)
      document.querySelectorAll('area').forEach(area => {
        area.dataset.found = '';
        area.onclick = () => trouverObjet(area.dataset.id);
      });
      startTimer();
      console.log("Nouvelle partie démarrée !");
    });

    // Événement pour enregistrer
    document.getElementById("enregistrer").addEventListener("click", function() {
      const pseudo = document.getElementById("pseudo").value;
      const temps = document.getElementById("temps-final").textContent;
      enregistrerScore(pseudo, temps);
    });

    // Initialisation au chargement
    window.onload = function() {
      const img = document.getElementById('scene-image');
      img.addEventListener('load', () => {
        console.log('Image chargée avec succès !');
        document.getElementById('image-error').style.display = 'none';
        genererZones();
      });
      img.addEventListener('error', () => {
        console.error('Erreur de chargement de l\'image !');
        document.getElementById('image-error').style.display = 'block';
      });
      if (img.complete) genererZones();  // Si déjà chargée

      // Régénère zones sur resize fenêtre
      window.addEventListener('resize', genererZones);

      chargerClassement();
    };
  </script>
</body>
</html>
